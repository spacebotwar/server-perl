<!doctype html><html>
    <head>
        <title>SpaceBot War Demo</title>
        <meta charset="utf-8" />
        <script type="text/javascript" src="/jquery.min.js"></script>
        <script type="text/javascript" src="/jquery.json.min.js"></script>
        <script type="text/javascript" src="/room.js"></script>

        <style type="text/css">
        <!--
        body {
            background-color: #ededed;
        }
        #canvas {
            background: #fff;
            border: 1px;
            solid : #cbcbcb;
        }
        -->
        </style>

%= stylesheet $_ for @{config->{extra_css}}
%= javascript $_ for @{config->{extra_js}}
% my $url = $self->req->url->to_abs->scheme($self->req->is_secure ? 'wss' : 'ws')->path('/');

<script>
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelRequestAnimationFrame = window[vendors[x]+
          'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };

    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}())

$(document).ready(function() {
    $('#content').room({"url" : "<%= $url %>"});
    var canvas = $('#canvas')[0];
    //var canvas = document.getElementById("canvas");
    context = canvas.getContext('2d');
    imageObj = new Image();
    imageObj.onLoad = function() {
//        context.drawImage(imageObj, 50,50);
    };
    imageObj.src = 'http://git.icydee.com:3000/sp_ship.png';
    bgImage = new Image();
    bgImage.src = 'http://git.icydee.com:3000/starfield.png';
    bgImage.onLoad = function() {};

    arena = new Arena({
        width   : 1000,
        height  : 1000,
        ships   : new Array()
    });
    arena.render();
});
var context;
var arena;
var imageObj;
var bgImage;
var date = new Date();
var init_t = -1;

function Ship(args) {
    this.x              = args.x,
    this.y              = args.y,
    this.direction      = args.direction,
    this.speed          = args.speed,
    this.rotation       = args.rotation,
    this.orientation    = args.orientation,
    this.status         = args.status,
    this.health         = args.health,
    this.init_t         = args.init_t
    var self = this;

    this.render=function() {
        var date = new Date();
        var now_t = date.getTime();
        var duration = now_t - this.init_t;
        var frac = duration / (this.init_t - this.prev_t);
        var delta_x = (this.x - this.prev_x) * frac;
        var delta_y = (this.y - this.prev_y) * frac;
        var delta_o = (this.orientation - this.prev_orientation);
        if (delta_o > Math.PI) {
            delta_o = delta_o - Math.PI * 2;
        }
        if (delta_o < 0-Math.PI) {
            delta_o = delta_o + Math.PI * 2;
        }
        delta_o = delta_o * frac;

        context.save();
        context.translate(this.prev_x + delta_x, this.prev_y + delta_y);
        context.rotate(0 + this.prev_orientation + delta_o);
        context.drawImage(imageObj, -35, -25);
        context.restore();
    }
};


function Arena(args) {
    this.ships  = args.ships;
    this.width  = args.width;
    this.height = args.height;
    this.time   = args.time;
    var self = this;

    this.render=function() {
        context.clearRect(0, 0, self.width, self.height);
        context.drawImage(bgImage,0,0);

        context.beginPath();
        context.fillStyle="#000066";

        for (var i in self.ships) {
            self.ships[i].render();
        }
        requestAnimationFrame(self.render);
    }

};
</script>


